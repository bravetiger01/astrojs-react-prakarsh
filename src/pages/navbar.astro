---
import GlassSurface from "../components/GlassSurface/GlassSurface";

const navLinks = [
  { name: "HOME", href: "/" },
  { name: "ABOUT", href: "/about" },
  { name: "EVENTS", href: "/events" },
  { name: "TEAMS", href: "/teams" },
];
---

<nav id="navbar" class="navbar">
  <GlassSurface client:load width="100%" borderRadius={50}>
    <div class="content">
      <div class="img justify-content:space-between">
        <img id="logo" src="/assets/logo.svg" alt="Logo" />

        <img id="logo" src="/assets/SvitLogo.svg" alt="Logo" />
      </div>
      <div class="img"></div>
      <div class="navlinks">
        <div class="links">
          {navLinks.map((l) => <a href={l.href}>{l.name}</a>)}
        </div>
        <a href="https://konfhub.com/svit" target="_blank" class="register-btn"
          >REGISTER NOW</a
        >
      </div>
    </div>
  </GlassSurface>
</nav>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  gsap.registerPlugin(ScrollTrigger);

  const logo = document.getElementById("logo");
  const navbar = document.getElementById("navbar");
  const loaderWrapper = document.getElementById("loader-wrapper");
  const canvas = document.getElementById("sprite-canvas");

  if (!logo || !navbar) {
    console.error("Logo or navbar not found");
  } else {
    function run() {
      const t = (window as any).__loaderTransition;
      if (!t) {
        console.log("No loader transition - showing navbar immediately");
        gsap.set(navbar, { opacity: 1 });
        document.documentElement.classList.remove("loading");
        // Show main content when no loader
        const mainContent = document.getElementById("main-content");
        if (mainContent) mainContent.classList.add("visible");
        return;
      }

      console.log("ðŸŽ¬ Starting transition animation");
      console.log("Transition data:", t);

      // Show navbar temporarily to measure logo position
      gsap.set(navbar, { opacity: 1, visibility: "visible" });

      requestAnimationFrame(() => {
        if (!logo || !canvas) return;

        // Get the logo's actual position on screen
        const final = logo.getBoundingClientRect();
        const finalX = final.left + final.width / 2;
        const finalY = final.top + final.height / 2;

        console.log("ðŸ“¦ Logo rect:", final);
        console.log(
          "ðŸ“ Canvas start:",
          t.x,
          t.y,
          "size:",
          t.width,
          "x",
          t.height,
        );
        console.log("ðŸ“ Logo target:", finalX, finalY);
        console.log("ðŸ“ Scale factor:", final.height / t.height);

        // Hide navbar again
        gsap.set(navbar, { opacity: 0, visibility: "hidden" });

        // Set canvas to fixed position at its current location FIRST
        gsap.set(canvas, {
          position: "fixed",
          left: t.x,
          top: t.y,
          x: "-50%",
          y: "-50%",
          zIndex: 10000,
        });

        // Animate the canvas to the navbar logo position
        const tl = gsap.timeline({
          onComplete() {
            // Hide canvas and loader
            if (loaderWrapper) {
              loaderWrapper.classList.add("fade-out");
              setTimeout(() => {
                if (loaderWrapper) loaderWrapper.style.display = "none";
                document.documentElement.classList.remove("loading");
                // Show main content after loader fades
                const mainContent = document.getElementById("main-content");
                if (mainContent) mainContent.classList.add("visible");
              }, 500);
            }

            // Show navbar
            gsap.set(navbar, { opacity: 1, visibility: "visible" });
            setupScroll();
            console.log("âœ¨ Animation complete!");
          },
        });

        // Animate canvas - use logo height for proper scaling
        tl.to(canvas, {
          left: finalX,
          top: finalY,
          scale: final.height / t.height,
          duration: 1.2,
          ease: "power3.out",
        });
      });
    }

    // Listen for loader complete event
    window.addEventListener("loader:complete", run);

    // If loader already completed (or skipped), run immediately
    if ((window as any).__loaderTransition !== undefined) {
      run();
    } else if (
      !loaderWrapper ||
      window.getComputedStyle(loaderWrapper).display === "none"
    ) {
      // No loader at all, show navbar
      gsap.set(navbar, { opacity: 1 });
    }

    function setupScroll() {
      if (!logo) return;
      ScrollTrigger.create({
        start: "top top",
        end: "+=300",
        scrub: true,
        onUpdate: (s) =>
          gsap.to(logo, {
            scale: gsap.utils.interpolate(1.15, 1, s.progress),
            duration: 0.1,
            overwrite: "auto",
          }),
      });
      console.log("ðŸ“œ Scroll animation setup");
    }
  }
</script>

<style>
  @import url("https://fonts.googleapis.com/css2?family=Bruno+Ace+SC&display=swap");
  .navbar {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 1200px;
    opacity: 0;
    z-index: 9900;
    font-family: "Bruno Ace SC", sans-serif;
  }

  .content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 40px;
    width: 100%;
  }

  .img {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    gap: 30px;
  }

  #logo {
    height: 40px;
    transform-origin: center;
  }

  .navlinks {
    display: flex;
    align-items: center;
    gap: 40px;
  }

  .links {
    display: flex;
    gap: 40px;
  }

  .links a {
    color: #000;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s;
  }

  .links a:hover {
    color: #b7654a;
  }

  .register-btn {
    background: linear-gradient(135deg, #f1b5a2 0%, #e89b88 100%);
    color: #000;
    text-decoration: none;
    padding: 12px 28px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(241, 181, 162, 0.5);
    flex-shrink: 0;
  }

  .register-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 25px rgba(241, 181, 162, 0.7);
  }
</style>
