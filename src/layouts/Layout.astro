---
import "../styles/index.css";
import Navbar from "../pages/navbar.astro";
import GlobalAudio from "../components/GlobalAudio.astro";
const { 
	title = "Prakarsh 2026",
	description = "Prakarsh - The Annual Technical Festival of SVIT College. Join us for exciting tech events, workshops, competitions, and esports tournaments."
} = Astro.props;

// Feature toggles for popups
const ENABLE_MUSIC_POPUP = false; // Set to true to enable music prompt popup
const ENABLE_ZOOM_POPUP = false; // Set to true to enable zoom/scaling notification popup
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<meta name="description" content={description} />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="apple-touch-icon" href="/favicon.svg" />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://www.prakarsh.org/" />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:site_name" content="Prakarsh 2026" />
		
		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content="https://www.prakarsh.org/" />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		
		<title>{title}</title>


		<link
			rel="preload"
			href="/sprites/sprite_sheet.avif"
			as="image"
			fetchpriority="high"
		/>

		<style>
			html.loading {
				overflow: hidden;
			}

			.loader-wrapper {
				position: fixed;
				inset: 0;
				background: black;
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				transition: opacity 0.5s ease;
			}

			.loader-wrapper.fade-out {
				opacity: 0;
				pointer-events: none;
			}

			#sprite-canvas {
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				transform-origin: center center;
			}

			/* Zoom notification popup */
			.zoom-notification {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: linear-gradient(135deg, #1a0f2e 0%, #2a1a3d 100%);
				border: 2px solid #f1b5a2;
				border-radius: 12px;
				padding: 2rem;
				max-width: 500px;
				z-index: 10001;
				box-shadow:
					0 0 40px rgba(241, 181, 162, 0.3),
					0 0 80px rgba(112, 0, 116, 0.2);
				animation: slideIn 0.3s ease-out;
			}

			.zoom-notification-overlay {
				position: fixed;
				inset: 0;
				background: linear-gradient(
					135deg,
					#0a0515 0%,
					#1a0f2e 50%,
					#0a0515 100%
				);
				z-index: 10000;
				animation: fadeIn 0.3s ease-out;
			}

			.zoom-notification h2 {
				color: #f1b5a2;
				font-size: 1.5rem;
				font-weight: bold;
				margin-bottom: 1rem;
				text-align: center;
				font-family: "Bruno Ace SC", sans-serif;
			}

			.zoom-notification p {
				color: rgba(255, 255, 255, 0.9);
				line-height: 1.6;
				margin-bottom: 1rem;
				text-align: center;
			}

			.zoom-notification .instructions {
				background: rgba(0, 0, 0, 0.3);
				border: 1px solid rgba(241, 181, 162, 0.3);
				border-radius: 8px;
				padding: 1rem;
				margin: 1rem 0;
			}

			.zoom-notification .instructions p {
				margin: 0.5rem 0;
				font-size: 0.9rem;
				color: rgba(255, 255, 255, 0.8);
			}

			.zoom-notification .instructions strong {
				color: #f1b5a2;
			}

			.zoom-notification button {
				width: 100%;
				padding: 0.75rem 1.5rem;
				background: linear-gradient(135deg, #f1b5a2, #e84faa);
				color: white;
				border: none;
				border-radius: 8px;
				font-weight: bold;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				margin-top: 1rem;
			}

			.zoom-notification button:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 20px rgba(241, 181, 162, 0.5);
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translate(-50%, -60%);
				}
				to {
					opacity: 1;
					transform: translate(-50%, -50%);
				}
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			.hidden {
				display: none !important;
			}

			/* Main content visibility control */
			#main-content {
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.5s ease;
			}

			#main-content.visible {
				opacity: 1;
				pointer-events: auto;
			}

			html.loading #main-content {
				opacity: 0 !important;
				pointer-events: none !important;
			}
		</style>
	</head>

	<body>
		<Navbar />
		<GlobalAudio />

		<!-- Music Enable Popup (appears before loading screen) -->
		<div
			id="music-enable-overlay"
			class="zoom-notification-overlay"
			style="z-index: 10002;"
		>
		</div>
		<div
			id="music-enable-popup"
			class="zoom-notification"
			style="z-index: 10003;"
		>
			<h2>üéµ IMMERSIVE EXPERIENCE</h2>
			<p>Enable background music for the best experience?</p>
			<p
				style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 0.5rem;"
			>
				You can toggle it anytime using the button in the corner
			</p>

			<div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
				<button
					id="music-enable-yes"
					style="flex: 1; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f1b5a2, #e84faa); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;"
				>
					Yes, Enable Music
				</button>
				<button
					id="music-enable-no"
					style="flex: 1; padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;"
				>
					No Thanks
				</button>
			</div>
		</div>

		<!-- Zoom Notification Popup -->
		<div
			id="zoom-notification-overlay"
			class="zoom-notification-overlay hidden"
		>
		</div>
		<div id="zoom-notification" class="zoom-notification hidden">
			<h2>‚ö° OPTIMAL VIEWING</h2>
			<p>
				This site is optimized for <strong>100% display scaling</strong>
			</p>
			<p
				style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem;"
			>
				If your Windows display scale is set to 125% or higher, please
				adjust your browser zoom to <strong>80%</strong> for the best experience
			</p>

			<div class="instructions">
				<p>
					<strong>Windows/Linux:</strong> Press <strong>Ctrl</strong> and
					<strong>-</strong> (minus) twice
				</p>
				<p>
					<strong>Mac:</strong> Press <strong>‚åò</strong> and <strong
						>-</strong
					> (minus) twice
				</p>
				<p>
					<strong>Or:</strong> Hold <strong>Ctrl/‚åò</strong> and scroll down
					with your mouse wheel
				</p>
			</div>

			<p
				style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 1rem; font-style: italic;"
			>
				üí° Already using 100% display scaling? You're all set!
			</p>

			<button id="zoom-notification-close">Got it!</button>
		</div>

		<div id="loader-wrapper" class="loader-wrapper">
			<canvas id="sprite-canvas"></canvas>
		</div>

		<!-- LOADER CONTROL + EVENT DISPATCH -->
		<script is:inline define:vars={{ ENABLE_MUSIC_POPUP, ENABLE_ZOOM_POPUP }}>
			const EXPIRY_TIME = 60 * 60 * 1000;
			const LOCK_KEY = "loaderLastShown";
			const MUSIC_PROMPT_KEY = "musicPromptShown";

			function shouldShowLoader() {
				if (location.pathname !== "/") return false;
				const last = sessionStorage.getItem(LOCK_KEY);
				return !last || Date.now() - +last > EXPIRY_TIME;
			}

			// Get elements
			const audio = document.getElementById("background-music");
			const audioToggle = document.getElementById("audio-toggle");
			const iconPlaying = document.getElementById("audio-icon-playing");
			const iconPaused = document.getElementById("audio-icon-paused");
			const musicPopup = document.getElementById("music-enable-popup");
			const musicOverlay = document.getElementById(
				"music-enable-overlay",
			);
			const musicYesBtn = document.getElementById("music-enable-yes");
			const musicNoBtn = document.getElementById("music-enable-no");
			const loader = document.getElementById("loader-wrapper");

			let isPlaying = false;

			// Set volume to 30%
			if (audio) {
				audio.volume = 0.3;
			}

			const showMusicPrompt = ENABLE_MUSIC_POPUP && !sessionStorage.getItem(MUSIC_PROMPT_KEY);
			const showLoader = shouldShowLoader();

			// Initial setup
			if (showMusicPrompt) {
				// Show music popup, hide loader and content
				if (loader) loader.style.display = "none";
				if (musicPopup) musicPopup.style.display = "block";
				if (musicOverlay) musicOverlay.style.display = "block";
				document.documentElement.classList.add("loading");
			} else {
				// Hide music popup (always hidden when ENABLE_MUSIC_POPUP is false)
				if (musicPopup) musicPopup.style.display = "none";
				if (musicOverlay) musicOverlay.style.display = "none";

				// Show or hide loader based on shouldShowLoader
				if (!showLoader) {
					if (loader) loader.style.display = "none";
				} else {
					// Show loader
					if (loader) loader.style.display = "flex";
					document.documentElement.classList.add("loading");
					sessionStorage.setItem(LOCK_KEY, Date.now());
				}
			}

			// Handle music enable buttons
			if (musicYesBtn && musicNoBtn && audio) {
				const handleMusicChoice = (enableMusic) => {
					sessionStorage.setItem(MUSIC_PROMPT_KEY, "true");

					// Save preference to localStorage for cross-page persistence
					localStorage.setItem(
						"musicEnabled",
						enableMusic ? "true" : "false",
					);

					if (enableMusic) {
						// Start music
						audio
							.play()
							.then(() => {
								isPlaying = true;
								if (iconPlaying)
									iconPlaying.style.display = "block";
								if (iconPaused)
									iconPaused.style.display = "none";
								// Update toggle button state
								const audioToggle =
									document.getElementById("audio-toggle");
								if (audioToggle)
									audioToggle.classList.remove("paused");
								console.log("üéµ Background music started");
							})
							.catch((error) => {
								console.log("‚è∏Ô∏è Music play failed:", error);
								if (iconPlaying)
									iconPlaying.style.display = "none";
								if (iconPaused)
									iconPaused.style.display = "block";
							});
					} else {
						// Set icon to paused
						if (iconPlaying) iconPlaying.style.display = "none";
						if (iconPaused) iconPaused.style.display = "block";
						// Update toggle button state
						const audioToggle =
							document.getElementById("audio-toggle");
						if (audioToggle) audioToggle.classList.add("paused");
					}

					// Hide popup
					if (musicPopup) musicPopup.classList.add("hidden");
					if (musicOverlay) musicOverlay.classList.add("hidden");

					// Show loader if needed
					if (showLoader && loader) {
						loader.style.display = "flex";
						sessionStorage.setItem(LOCK_KEY, Date.now());

						// Set flag and call callback if PixiJS already set it up
						window.__loaderStarted = true;
						if (typeof window.__startPixiAnimation === "function") {
							window.__startPixiAnimation();
						}

						// Start the loader completion timer (animation takes ~6.3s)
						const ANIMATION_DURATION = 6300;
						setTimeout(() => {
							const canvas =
								document.getElementById("sprite-canvas");
							if (canvas) {
								const rect = canvas.getBoundingClientRect();
								window.__loaderTransition = {
									x: rect.left + rect.width / 2,
									y: rect.top + rect.height / 2,
									width: rect.width,
									height: rect.height,
								};
							}

							console.log(
								"üéØ Loader complete (after music choice), dispatching event",
							);
							window.dispatchEvent(new Event("loader:complete"));

							// Show zoom notification after loading screen finishes (desktop only)
							const isMobileDevice =
								/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
									navigator.userAgent,
								);
							const ZOOM_NOTIFICATION_KEY =
								"zoomNotificationShown";

							if (
								ENABLE_ZOOM_POPUP &&
								!isMobileDevice &&
								!sessionStorage.getItem(ZOOM_NOTIFICATION_KEY)
							) {
								setTimeout(() => {
									const overlay = document.getElementById(
										"zoom-notification-overlay",
									);
									const notification =
										document.getElementById(
											"zoom-notification",
										);
									const closeBtn = document.getElementById(
										"zoom-notification-close",
									);

									if (overlay && notification && closeBtn) {
										overlay.classList.remove("hidden");
										notification.classList.remove("hidden");

										const closeNotification = () => {
											overlay.classList.add("hidden");
											notification.classList.add(
												"hidden",
											);
											sessionStorage.setItem(
												ZOOM_NOTIFICATION_KEY,
												"true",
											);
										};

										closeBtn.addEventListener(
											"click",
											closeNotification,
										);
										overlay.addEventListener(
											"click",
											closeNotification,
										);
									}
								}, 500);
							}
						}, ANIMATION_DURATION);
					} else {
						// No loader, remove loading class and show content
						document.documentElement.classList.remove("loading");
						const mainContent =
							document.getElementById("main-content");
						if (mainContent) mainContent.classList.add("visible");
					}
				};

				musicYesBtn.addEventListener("click", () =>
					handleMusicChoice(true),
				);
				musicNoBtn.addEventListener("click", () =>
					handleMusicChoice(false),
				);

				// Hover effects for buttons
				musicYesBtn.addEventListener("mouseenter", () => {
					musicYesBtn.style.transform = "translateY(-2px)";
					musicYesBtn.style.boxShadow =
						"0 4px 20px rgba(241, 181, 162, 0.5)";
				});
				musicYesBtn.addEventListener("mouseleave", () => {
					musicYesBtn.style.transform = "translateY(0)";
					musicYesBtn.style.boxShadow = "none";
				});

				musicNoBtn.addEventListener("mouseenter", () => {
					musicNoBtn.style.transform = "translateY(-2px)";
					musicNoBtn.style.background = "rgba(255, 255, 255, 0.15)";
				});
				musicNoBtn.addEventListener("mouseleave", () => {
					musicNoBtn.style.transform = "translateY(0)";
					musicNoBtn.style.background = "rgba(255, 255, 255, 0.1)";
				});
			}

			// Toggle audio on button click
			if (audioToggle && audio) {
				audioToggle.addEventListener("click", () => {
					if (isPlaying) {
						audio.pause();
						isPlaying = false;
						iconPlaying.style.display = "none";
						iconPaused.style.display = "block";
						audioToggle.style.background =
							"linear-gradient(135deg, #6B3FA0, #3c2a56)";
					} else {
						audio.play();
						isPlaying = true;
						iconPlaying.style.display = "block";
						iconPaused.style.display = "none";
						audioToggle.style.background =
							"linear-gradient(135deg, #f1b5a2, #e84faa)";
					}
				});

				// Hover effect
				audioToggle.addEventListener("mouseenter", () => {
					audioToggle.style.transform = "scale(1.1)";
					audioToggle.style.boxShadow =
						"0 6px 30px rgba(241, 181, 162, 0.6)";
				});

				audioToggle.addEventListener("mouseleave", () => {
					audioToggle.style.transform = "scale(1)";
					audioToggle.style.boxShadow =
						"0 4px 20px rgba(241, 181, 162, 0.4)";
				});
			}

			// Loader animation logic
			if (!showLoader || showMusicPrompt) {
				// Don't run loader animation - show content immediately
				if (!showMusicPrompt) {
					// No popup and no loader - show content right away
					document.addEventListener("DOMContentLoaded", () => {
						document.documentElement.classList.remove("loading");
						const mainContent = document.getElementById("main-content");
						if (mainContent) mainContent.classList.add("visible");
					});
				}
			} else {
				// Run loader animation
				// Prevent scrollbar during loading
				sessionStorage.setItem(LOCK_KEY, Date.now());

				// Animation completes in ~5.5s (330 frames at 60fps)
				const ANIMATION_DURATION = 6300;

				window.addEventListener("load", () => {
					setTimeout(() => {
						const canvas = document.getElementById("sprite-canvas");
						const rect = canvas.getBoundingClientRect();

						window.__loaderTransition = {
							x: rect.left + rect.width / 2,
							y: rect.top + rect.height / 2,
							width: rect.width,
							height: rect.height,
						};

						console.log("üéØ Loader complete, dispatching event");
						window.dispatchEvent(new Event("loader:complete"));

						// Show main content after loader
						setTimeout(() => {
							document.documentElement.classList.remove("loading");
							const mainContent = document.getElementById("main-content");
							if (mainContent) {
								mainContent.classList.add("visible");
								console.log("‚úÖ Main content visible");
							}
						}, 1500); // Small delay for navbar animation

						// Show zoom notification after loading screen finishes (desktop only)
						const isMobileDevice =
							/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
								navigator.userAgent,
							);
						const ZOOM_NOTIFICATION_KEY = "zoomNotificationShown";

						if (
							ENABLE_ZOOM_POPUP &&
							!isMobileDevice &&
							!sessionStorage.getItem(ZOOM_NOTIFICATION_KEY)
						) {
							setTimeout(() => {
								const overlay = document.getElementById(
									"zoom-notification-overlay",
								);
								const notification =
									document.getElementById(
										"zoom-notification",
									);
								const closeBtn = document.getElementById(
									"zoom-notification-close",
								);

								if (overlay && notification && closeBtn) {
									overlay.classList.remove("hidden");
									notification.classList.remove("hidden");

									const closeNotification = () => {
										overlay.classList.add("hidden");
										notification.classList.add("hidden");
										sessionStorage.setItem(
											ZOOM_NOTIFICATION_KEY,
											"true",
										);
									};

									closeBtn.addEventListener(
										"click",
										closeNotification,
									);
									overlay.addEventListener(
										"click",
										closeNotification,
									);
								}
							}, 500); // Small delay after loader finishes
						}

						// Navbar animation script handles fade-out after merge animation
					}, ANIMATION_DURATION);
				});
			}
		</script>

		<!-- PIXI LOADER (LOCKS ON LAST FRAME) -->
		<script>
			import {
				Application,
				Assets,
				Sprite,
				Texture,
				Rectangle,
			} from "pixi.js";

			const loader = document.getElementById("loader-wrapper");
			
			// Only initialize if loader is visible
			if (!loader || getComputedStyle(loader).display === "none") {
				console.log("Loader not shown, skipping PixiJS");
			} else {
				console.log("üé® Initializing PixiJS loader...");

				const SPRITE = {
					path: "/sprites/sprite_sheet.avif",
					cols: 15,
					rows: 22,
					w: 7500 / 15,
					h: 11000 / 22,
					fps: 60,
					scale: 0.6,
				};

				async function initPixi() {
					const canvas = document.getElementById("sprite-canvas");
					if (!canvas) {
						console.error("Canvas not found");
						return;
					}

					const app = new Application();
					await app.init({
						canvas: canvas as HTMLCanvasElement,
						width: SPRITE.w * SPRITE.scale,
						height: SPRITE.h * SPRITE.scale,
						backgroundAlpha: 0,
						resolution: window.devicePixelRatio || 1,
						autoDensity: true,
					});

					console.log("üì¶ Loading sprite sheet...");
					const base = await Assets.load(SPRITE.path);
					const frames: Texture[] = [];

					for (let r = 0; r < SPRITE.rows; r++) {
						for (let c = 0; c < SPRITE.cols; c++) {
							frames.push(
								new Texture({
									source: base.source,
									frame: new Rectangle(
										c * SPRITE.w,
										r * SPRITE.h,
										SPRITE.w,
										SPRITE.h,
									),
								}),
							);
						}
					}

					console.log(`‚úÖ Loaded ${frames.length} frames`);

					const sprite = new Sprite(frames[0]);
					sprite.anchor.set(0.5);
					sprite.scale.set(SPRITE.scale);
					sprite.x = app.screen.width / 2;
					sprite.y = app.screen.height / 2;
					app.stage.addChild(sprite);

					let frame = 0;
					let acc = 0;
					const delay = 1000 / SPRITE.fps;

					const speedMultiplier = 1;

					app.ticker.add((t) => {
						acc += t.deltaMS;

						const framesToAdvance = Math.floor(
							(acc / delay) * speedMultiplier,
						);

						if (framesToAdvance > 0) {
							acc = acc % delay;

							frame = Math.min(
								frame + framesToAdvance,
								frames.length - 1,
							);

							sprite.texture = frames[frame];
						}
					});
					console.log("üé¨ Animation started!");
				}

				// Start PixiJS immediately (no music popup)
				console.log("üé® Starting PixiJS immediately...");
				initPixi().catch((err) => {
					console.error("Failed to initialize PixiJS:", err);
				});
			}
		</script>

		<!-- PREFETCH EVENT DATA DURING LOADING -->
		<script>
			import { prefetchAllEvents } from "../lib/event-cache";

			const loader = document.getElementById("loader-wrapper");

			// Only prefetch if loader is visible
			if (loader && getComputedStyle(loader).display !== "none") {
				console.log(
					"üöÄ Starting data prefetch during loading animation...",
				);

				// Start prefetching immediately
				const prefetchStart = performance.now();

				prefetchAllEvents()
					.then(() => {
						const prefetchTime = performance.now() - prefetchStart;
						console.log(
							`‚úÖ Data prefetch completed in ${Math.round(prefetchTime)}ms`,
						);
					})
					.catch((error) => {
						console.warn(
							"‚ö†Ô∏è Prefetch failed, will use local data:",
							error,
						);
					});
			} else {
				console.log(
					"‚ÑπÔ∏è Loader not shown, skipping prefetch (will fetch on-demand)",
				);
			}
		</script>

		<!-- Main content wrapper - hidden until loading sequence completes -->
		<div id="main-content">
			<slot />
		</div>
	</body>
</html>
