---
import "../styles/index.css";
import Navbar from "../pages/navbar.astro";
const { title = "Astro Basics" } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<title>{title}</title>

		<link
			rel="preload"
			href="/sprites/sprite_sheet.avif"
			as="image"
			fetchpriority="high"
		/>

		<style>
			html.loading {
				overflow: hidden;
			}

			.loader-wrapper {
				position: fixed;
				inset: 0;
				background: black;
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				transition: opacity 0.5s ease;
			}

			.loader-wrapper.fade-out {
				opacity: 0;
				pointer-events: none;
			}

			#sprite-canvas {
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				transform-origin: center center;
			}
		</style>
	</head>

	<body>
		<Navbar />

		<div id="loader-wrapper" class="loader-wrapper">
			<canvas id="sprite-canvas"></canvas>
		</div>

		<!-- LOADER CONTROL + EVENT DISPATCH -->
		<script is:inline>
			const EXPIRY_TIME = 60 * 60 * 1000;
			const LOCK_KEY = "loaderLastShown";

			function shouldShowLoader() {
				if (location.pathname !== "/") return false;
				const last = sessionStorage.getItem(LOCK_KEY);
				return !last || Date.now() - +last > EXPIRY_TIME;
			}

			const showLoader = shouldShowLoader();
			const loader = document.getElementById("loader-wrapper");

			if (!showLoader) {
				loader.style.display = "none";
			} else {
				// Prevent scrollbar during loading
				document.documentElement.classList.add("loading");
				sessionStorage.setItem(LOCK_KEY, Date.now());

				// Animation completes in ~5.5s (330 frames at 60fps)
				const ANIMATION_DURATION = 5500;

				window.addEventListener("load", () => {
					setTimeout(() => {
						const canvas = document.getElementById("sprite-canvas");
						const rect = canvas.getBoundingClientRect();

						window.__loaderTransition = {
							x: rect.left + rect.width / 2,
							y: rect.top + rect.height / 2,
							width: rect.width,
							height: rect.height,
						};

						console.log("ðŸŽ¯ Loader complete, dispatching event");
						window.dispatchEvent(new Event("loader:complete"));
						// Navbar animation script handles fade-out after merge animation
					}, ANIMATION_DURATION);
				});
			}
		</script>

		<!-- PIXI LOADER (LOCKS ON LAST FRAME) -->
		<script>
			import {
				Application,
				Assets,
				Sprite,
				Texture,
				Rectangle,
			} from "pixi.js";

			const loader = document.getElementById("loader-wrapper");
			if (!loader || getComputedStyle(loader).display === "none") {
				console.log("Loader not shown, skipping PixiJS");
			} else {
				console.log("ðŸŽ¨ Initializing PixiJS loader...");

				const SPRITE = {
					path: "/sprites/sprite_sheet.avif",
					cols: 15,
					rows: 22,
					w: 7500 / 15,
					h: 11000 / 22,
					fps: 60,
					scale: 0.6,
				};

				async function initPixi() {
					const canvas = document.getElementById("sprite-canvas");
					if (!canvas) {
						console.error("Canvas not found");
						return;
					}

					const app = new Application();
					await app.init({
						canvas: canvas as HTMLCanvasElement,
						width: SPRITE.w * SPRITE.scale,
						height: SPRITE.h * SPRITE.scale,
						backgroundAlpha: 0,
						resolution: window.devicePixelRatio || 1,
						autoDensity: true,
					});

					console.log("ðŸ“¦ Loading sprite sheet...");
					const base = await Assets.load(SPRITE.path);
					const frames: Texture[] = [];

					for (let r = 0; r < SPRITE.rows; r++) {
						for (let c = 0; c < SPRITE.cols; c++) {
							frames.push(
								new Texture({
									source: base.source,
									frame: new Rectangle(
										c * SPRITE.w,
										r * SPRITE.h,
										SPRITE.w,
										SPRITE.h,
									),
								}),
							);
						}
					}

					console.log(`âœ… Loaded ${frames.length} frames`);

					const sprite = new Sprite(frames[0]);
					sprite.anchor.set(0.5);
					sprite.scale.set(SPRITE.scale);
					sprite.x = app.screen.width / 2;
					sprite.y = app.screen.height / 2;
					app.stage.addChild(sprite);

					let frame = 0;
					let acc = 0;
					const delay = 1000 / SPRITE.fps;

					const speedMultiplier = 1;

					app.ticker.add((t) => {
						acc += t.deltaMS;

						const framesToAdvance = Math.floor(
							(acc / delay) * speedMultiplier,
						);

						if (framesToAdvance > 0) {
							acc = acc % delay;

							frame = Math.min(
								frame + framesToAdvance,
								frames.length - 1,
							);

							sprite.texture = frames[frame];
						}
					});

					console.log("ðŸŽ¬ Animation started!");
				}

				initPixi().catch((err) => {
					console.error("Failed to initialize PixiJS:", err);
				});
			}
		</script>

		<slot />
	</body>
</html>
