---
import "../styles/index.css";
import Navbar from "../pages/navbar.astro";
const { title = "Prakarsh 2026" } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="apple-touch-icon" href="/favicon.svg" />
		
		<title>{title}</title>

		<link
			rel="preload"
			href="/sprites/sprite_sheet.avif"
			as="image"
			fetchpriority="high"
		/>

		<style>
			html.loading {
				overflow: hidden;
			}

			.loader-wrapper {
				position: fixed;
				inset: 0;
				background: black;
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				transition: opacity 0.5s ease;
			}

			.loader-wrapper.fade-out {
				opacity: 0;
				pointer-events: none;
			}

			#sprite-canvas {
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				transform-origin: center center;
			}

			/* Zoom notification popup */
			.zoom-notification {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: linear-gradient(135deg, #1a0f2e 0%, #2a1a3d 100%);
				border: 2px solid #f1b5a2;
				border-radius: 12px;
				padding: 2rem;
				max-width: 500px;
				z-index: 10001;
				box-shadow: 0 0 40px rgba(241, 181, 162, 0.3), 0 0 80px rgba(112, 0, 116, 0.2);
				animation: slideIn 0.3s ease-out;
			}

			.zoom-notification-overlay {
				position: fixed;
				inset: 0;
				background: rgba(0, 0, 0, 0.8);
				backdrop-filter: blur(4px);
				z-index: 10000;
				animation: fadeIn 0.3s ease-out;
			}

			.zoom-notification h2 {
				color: #f1b5a2;
				font-size: 1.5rem;
				font-weight: bold;
				margin-bottom: 1rem;
				text-align: center;
				font-family: 'Bruno Ace SC', sans-serif;
			}

			.zoom-notification p {
				color: rgba(255, 255, 255, 0.9);
				line-height: 1.6;
				margin-bottom: 1rem;
				text-align: center;
			}

			.zoom-notification .instructions {
				background: rgba(0, 0, 0, 0.3);
				border: 1px solid rgba(241, 181, 162, 0.3);
				border-radius: 8px;
				padding: 1rem;
				margin: 1rem 0;
			}

			.zoom-notification .instructions p {
				margin: 0.5rem 0;
				font-size: 0.9rem;
				color: rgba(255, 255, 255, 0.8);
			}

			.zoom-notification .instructions strong {
				color: #f1b5a2;
			}

			.zoom-notification button {
				width: 100%;
				padding: 0.75rem 1.5rem;
				background: linear-gradient(135deg, #f1b5a2, #e84faa);
				color: white;
				border: none;
				border-radius: 8px;
				font-weight: bold;
				font-size: 1rem;
				cursor: pointer;
				transition: all 0.3s ease;
				margin-top: 1rem;
			}

			.zoom-notification button:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 20px rgba(241, 181, 162, 0.5);
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translate(-50%, -60%);
				}
				to {
					opacity: 1;
					transform: translate(-50%, -50%);
				}
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			.hidden {
				display: none !important;
			}
		</style>
	</head>

	<body>
		<Navbar />

		<!-- Zoom Notification Popup -->
		<div id="zoom-notification-overlay" class="zoom-notification-overlay hidden"></div>
		<div id="zoom-notification" class="zoom-notification hidden">
			<h2>‚ö° OPTIMAL VIEWING</h2>
			<p>This site is optimized for <strong>100% display scaling</strong></p>
			<p style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem;">
				If your Windows display scale is set to 125% or higher, please adjust your browser zoom to <strong>80%</strong> for the best experience
			</p>
			
			<div class="instructions">
				<p><strong>Windows/Linux:</strong> Press <strong>Ctrl</strong> and <strong>-</strong> (minus) twice</p>
				<p><strong>Mac:</strong> Press <strong>‚åò</strong> and <strong>-</strong> (minus) twice</p>
				<p><strong>Or:</strong> Hold <strong>Ctrl/‚åò</strong> and scroll down with your mouse wheel</p>
			</div>

			<p style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-top: 1rem; font-style: italic;">
				üí° Already using 100% display scaling? You're all set!
			</p>

			<button id="zoom-notification-close">Got it!</button>
		</div>

		<div id="loader-wrapper" class="loader-wrapper">
			<canvas id="sprite-canvas"></canvas>
		</div>

		<!-- LOADER CONTROL + EVENT DISPATCH -->
		<script is:inline>
			const EXPIRY_TIME = 60 * 60 * 1000;
			const LOCK_KEY = "loaderLastShown";

			function shouldShowLoader() {
				if (location.pathname !== "/") return false;
				const last = sessionStorage.getItem(LOCK_KEY);
				return !last || Date.now() - +last > EXPIRY_TIME;
			}

			const showLoader = shouldShowLoader();
			const loader = document.getElementById("loader-wrapper");

			if (!showLoader) {
				loader.style.display = "none";
			} else {
				// Prevent scrollbar during loading
				document.documentElement.classList.add("loading");
				sessionStorage.setItem(LOCK_KEY, Date.now());

				// Animation completes in ~5.5s (330 frames at 60fps)
				const ANIMATION_DURATION = 6300;

				window.addEventListener("load", () => {
					setTimeout(() => {
						const canvas = document.getElementById("sprite-canvas");
						const rect = canvas.getBoundingClientRect();

						window.__loaderTransition = {
							x: rect.left + rect.width / 2,
							y: rect.top + rect.height / 2,
							width: rect.width,
							height: rect.height,
						};

						console.log("üéØ Loader complete, dispatching event");
						window.dispatchEvent(new Event("loader:complete"));
						
						// Show zoom notification after loading screen finishes (desktop only)
						const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
						const ZOOM_NOTIFICATION_KEY = "zoomNotificationShown";
						
						if (!isMobileDevice && !sessionStorage.getItem(ZOOM_NOTIFICATION_KEY)) {
							setTimeout(() => {
								const overlay = document.getElementById("zoom-notification-overlay");
								const notification = document.getElementById("zoom-notification");
								const closeBtn = document.getElementById("zoom-notification-close");

								if (overlay && notification && closeBtn) {
									overlay.classList.remove("hidden");
									notification.classList.remove("hidden");

									const closeNotification = () => {
										overlay.classList.add("hidden");
										notification.classList.add("hidden");
										sessionStorage.setItem(ZOOM_NOTIFICATION_KEY, "true");
									};

									closeBtn.addEventListener("click", closeNotification);
									overlay.addEventListener("click", closeNotification);
								}
							}, 500); // Small delay after loader finishes
						}
						
						// Navbar animation script handles fade-out after merge animation
					}, ANIMATION_DURATION);
				});
			}
		</script>

		<!-- PIXI LOADER (LOCKS ON LAST FRAME) -->
		<script>
			import {
				Application,
				Assets,
				Sprite,
				Texture,
				Rectangle,
			} from "pixi.js";

			const loader = document.getElementById("loader-wrapper");
			if (!loader || getComputedStyle(loader).display === "none") {
				console.log("Loader not shown, skipping PixiJS");
			} else {
				console.log("üé® Initializing PixiJS loader...");

				const SPRITE = {
					path: "/sprites/sprite_sheet.avif",
					cols: 15,
					rows: 22,
					w: 7500 / 15,
					h: 11000 / 22,
					fps: 60,
					scale: 0.6,
				};

				async function initPixi() {
					const canvas = document.getElementById("sprite-canvas");
					if (!canvas) {
						console.error("Canvas not found");
						return;
					}

					const app = new Application();
					await app.init({
						canvas: canvas as HTMLCanvasElement,
						width: SPRITE.w * SPRITE.scale,
						height: SPRITE.h * SPRITE.scale,
						backgroundAlpha: 0,
						resolution: window.devicePixelRatio || 1,
						autoDensity: true,
					});

					console.log("üì¶ Loading sprite sheet...");
					const base = await Assets.load(SPRITE.path);
					const frames: Texture[] = [];

					for (let r = 0; r < SPRITE.rows; r++) {
						for (let c = 0; c < SPRITE.cols; c++) {
							frames.push(
								new Texture({
									source: base.source,
									frame: new Rectangle(
										c * SPRITE.w,
										r * SPRITE.h,
										SPRITE.w,
										SPRITE.h,
									),
								}),
							);
						}
					}

					console.log(`‚úÖ Loaded ${frames.length} frames`);

					const sprite = new Sprite(frames[0]);
					sprite.anchor.set(0.5);
					sprite.scale.set(SPRITE.scale);
					sprite.x = app.screen.width / 2;
					sprite.y = app.screen.height / 2;
					app.stage.addChild(sprite);

					let frame = 0;
					let acc = 0;
					const delay = 1000 / SPRITE.fps;

					const speedMultiplier = 1;

					app.ticker.add((t) => {
						acc += t.deltaMS;

						const framesToAdvance = Math.floor(
							(acc / delay) * speedMultiplier,
						);

						if (framesToAdvance > 0) {
							acc = acc % delay;

							frame = Math.min(
								frame + framesToAdvance,
								frames.length - 1,
							);

							sprite.texture = frames[frame];
						}
					});

					console.log("üé¨ Animation started!");
				}

				initPixi().catch((err) => {
					console.error("Failed to initialize PixiJS:", err);
				});
			}
			
		</script>

		<!-- PREFETCH EVENT DATA DURING LOADING -->
		<script>
			import { prefetchAllEvents } from "../lib/event-cache";

			const loader = document.getElementById("loader-wrapper");
			
			// Only prefetch if loader is visible
			if (loader && getComputedStyle(loader).display !== "none") {
				console.log("üöÄ Starting data prefetch during loading animation...");
				
				// Start prefetching immediately
				const prefetchStart = performance.now();
				
				prefetchAllEvents()
					.then(() => {
						const prefetchTime = performance.now() - prefetchStart;
						console.log(`‚úÖ Data prefetch completed in ${Math.round(prefetchTime)}ms`);
					})
					.catch((error) => {
						console.warn("‚ö†Ô∏è Prefetch failed, will use local data:", error);
					});
			} else {
				console.log("‚ÑπÔ∏è Loader not shown, skipping prefetch (will fetch on-demand)");
			}
		</script>

		<slot />

</body>
	</body>
</html>
